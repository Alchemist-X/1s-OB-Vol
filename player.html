<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Book Replay</title>
<style>
  :root {
    --bg: #ffffff;
    --surface: #ffffff;
    --border: #e8e8e8;
    --text: #1a1a2e;
    --text-dim: #858999;
    --green: #47a867;
    --green-bg: rgba(71,168,103,0.12);
    --red: #d45353;
    --red-bg: rgba(212,83,83,0.12);
    --blue: #4285f4;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: #f5f5f5; color: var(--text);
    display: flex; justify-content: center; padding: 24px; min-height: 100vh;
  }
  #app { width: 620px; }

  /* Drop zone */
  #dropzone {
    background: var(--bg); border: 2px dashed var(--border); border-radius: 12px;
    padding: 80px 24px; text-align: center; cursor: pointer; transition: border-color .2s;
  }
  #dropzone:hover, #dropzone.drag-over { border-color: var(--blue); }
  #dropzone h2 { margin-bottom: 8px; font-weight: 600; color: var(--text); }
  #dropzone p { color: var(--text-dim); font-size: 14px; }
  #dropzone code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 13px; }
  #file-input { display: none; }

  /* Header */
  #header { display: none; margin-bottom: 12px; }
  #market-title { font-size: 16px; font-weight: 700; margin-bottom: 10px; line-height: 1.4; color: var(--text); }
  .badges { display: flex; gap: 10px; }
  .badge {
    padding: 8px 20px; border-radius: 24px; font-weight: 700; font-size: 14px;
    min-width: 120px; text-align: center;
  }
  .badge-yes { background: var(--text); color: #fff; }
  .badge-no  { background: #fff; color: var(--red); border: 1.5px solid var(--border); }

  /* Order Book */
  #orderbook {
    display: none; background: var(--bg); border-radius: 12px;
    border: 1px solid var(--border); overflow: hidden;
  }

  /* Tabs bar */
  .tab-bar {
    display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid var(--border);
  }
  .tab-bar .tab {
    padding: 12px 16px; font-size: 14px; font-weight: 600; color: var(--text-dim);
    cursor: default; position: relative;
  }
  .tab-bar .tab.active { color: var(--text); }
  .tab-bar .tab.active::after {
    content: ''; position: absolute; bottom: 0; left: 16px; right: 16px;
    height: 2px; background: var(--blue); border-radius: 2px;
  }

  /* Column header */
  .col-header {
    display: grid; grid-template-columns: 80px 1fr 120px 120px;
    padding: 10px 16px; font-size: 12px; color: var(--text-dim);
    text-transform: uppercase; letter-spacing: .3px; font-weight: 600;
    border-bottom: 1px solid var(--border);
  }
  .col-header span:nth-child(3),
  .col-header span:nth-child(4) { text-align: right; }

  /* Rows */
  .ob-row {
    display: grid; grid-template-columns: 80px 1fr 120px 120px;
    padding: 6px 16px; font-size: 14px; position: relative; align-items: center;
    min-height: 36px;
  }
  .ob-row .bar {
    position: absolute; top: 0; bottom: 0; left: 0;
    pointer-events: none; transition: width .3s ease;
  }
  .ob-row span { position: relative; z-index: 1; }
  .ob-row .col-price { font-weight: 700; text-align: center; }
  .ob-row .col-size { text-align: right; color: var(--text); }
  .ob-row .col-total { text-align: right; color: var(--text-dim); }

  .ask-row .col-price { color: var(--red); }
  .ask-row .bar { background: var(--red-bg); }
  .bid-row .col-price { color: var(--green); }
  .bid-row .bar { background: var(--green-bg); }

  /* Side label badge inline */
  .side-badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; font-weight: 700; color: #fff; letter-spacing: .3px;
    position: relative; z-index: 1;
  }
  .side-badge.ask-badge { background: var(--red); }
  .side-badge.bid-badge { background: var(--green); }

  /* Mid bar */
  .mid-bar {
    display: flex; justify-content: space-between; padding: 10px 16px;
    font-size: 14px; color: var(--text-dim);
    border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
  }
  .mid-bar strong { color: var(--text); font-weight: 700; }

  /* Info row */
  .info-row {
    display: flex; justify-content: space-between; padding: 10px 16px;
    font-size: 13px; color: var(--text-dim); border-top: 1px solid var(--border);
  }
  .info-row .val { color: var(--text); font-weight: 500; }
  .info-row .vol-val { color: var(--blue); font-weight: 700; }

  /* Depth summary */
  .depth-row {
    display: flex; justify-content: center; gap: 20px; padding: 8px 16px;
    font-size: 12px; color: var(--text-dim);
  }
  .depth-item span { font-weight: 600; color: var(--text); }

  /* Controls */
  #controls {
    display: none; margin-top: 12px; background: var(--bg);
    border-radius: 12px; border: 1px solid var(--border); padding: 20px;
  }
  .playback-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 14px; }
  .pb-btn {
    background: #f5f5f5; border: 1px solid var(--border); color: var(--text);
    border-radius: 10px; width: 44px; height: 40px; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center; transition: all .15s;
  }
  .pb-btn:hover { background: #eaeaea; }
  .pb-btn.play {
    width: 56px; background: var(--blue); border-color: var(--blue); color: #fff;
    border-radius: 12px;
  }
  .pb-btn.play:hover { background: #3275e4; }

  .speed-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 16px; }
  .sp-btn {
    background: #f5f5f5; border: 1px solid var(--border); color: var(--text-dim);
    border-radius: 8px; padding: 6px 14px; font-size: 13px; font-weight: 500;
    cursor: pointer; transition: all .15s;
  }
  .sp-btn:hover { border-color: #bbb; }
  .sp-btn.active {
    background: var(--blue); border-color: var(--blue); color: #fff; font-weight: 700;
  }

  .timeline { display: flex; align-items: center; gap: 12px; }
  .timeline input[type=range] {
    flex: 1; accent-color: var(--blue); cursor: pointer;
    -webkit-appearance: none; height: 6px; background: #e0e0e0; border-radius: 3px; outline: none;
  }
  .timeline input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%;
    background: var(--blue); cursor: pointer; border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,.2);
  }
  .frame-info { font-size: 13px; color: var(--text-dim); min-width: 55px; text-align: right; white-space: nowrap; }
  .time-row {
    display: flex; justify-content: space-between; margin-top: 6px;
    font-size: 12px; color: var(--text-dim);
  }
</style>
</head>
<body>
<div id="app">
  <div id="dropzone" onclick="document.getElementById('file-input').click()">
    <h2>Order Book Replay</h2>
    <p>Drop a <code>replay.json</code> here or click to browse</p>
    <input type="file" id="file-input" accept=".json">
  </div>

  <div id="header">
    <div id="market-title"></div>
    <div class="badges">
      <div class="badge badge-yes" id="badge-yes"></div>
      <div class="badge badge-no" id="badge-no"></div>
    </div>
  </div>

  <div id="orderbook">
    <div class="tab-bar">
      <div class="tab active">Order Book</div>
    </div>
    <div class="col-header">
      <span></span><span>PRICE</span><span>SHARES</span><span>TOTAL</span>
    </div>
    <div id="asks"></div>
    <div class="mid-bar">
      <span>Last: <strong id="mid-last">--</strong></span>
      <span>Spread: <strong id="mid-spread">--</strong></span>
    </div>
    <div id="bids"></div>
    <div class="depth-row" id="depth-row"></div>
    <div class="info-row">
      <span>Volume: <span class="vol-val" id="info-vol">0</span></span>
      <span>Trades: <span class="val" id="info-trades">0</span></span>
      <span id="info-ts">--</span>
    </div>
  </div>

  <div id="controls">
    <div class="playback-row">
      <button class="pb-btn" id="btn-start" title="Start">&#x23EE;</button>
      <button class="pb-btn" id="btn-prev" title="Step back">&#x25C0;</button>
      <button class="pb-btn play" id="btn-play" title="Play/Pause">&#x25B6;</button>
      <button class="pb-btn" id="btn-next" title="Step forward">&#x25B6;</button>
      <button class="pb-btn" id="btn-end" title="End">&#x23ED;</button>
    </div>
    <div class="speed-row" id="speed-row"></div>
    <div class="timeline">
      <input type="range" id="scrubber" min="0" max="0" value="0">
      <span class="frame-info" id="frame-info">0/0</span>
    </div>
    <div class="time-row">
      <span id="t-start">--</span>
      <span id="t-end">--</span>
    </div>
  </div>
</div>

<script>
const SPEEDS = [0.25, 0.5, 1, 2, 5];
let D = null, idx = 0, playing = false, timer = null, speed = 1, interval = 5;

const $ = id => document.getElementById(id);
const dz = $('dropzone'), fi = $('file-input'), scrub = $('scrubber');

fi.addEventListener('change', e => { if (e.target.files[0]) load(e.target.files[0]); });
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag-over'); if (e.dataTransfer.files[0]) load(e.dataTransfer.files[0]); });

function load(file) {
  const r = new FileReader();
  r.onload = e => { try { D = JSON.parse(e.target.result); init(); } catch(err) { alert('Bad JSON: ' + err.message); } };
  r.readAsText(file);
}

function init() {
  dz.style.display = 'none';
  $('header').style.display = 'block';
  $('orderbook').style.display = 'block';
  $('controls').style.display = 'block';

  const m = D.meta || {};
  const oc = m.outcomes || ['Yes','No'];
  interval = m.poll_interval || 5;

  $('market-title').textContent = m.question || 'Order Book Replay';
  $('badge-yes').textContent = oc[0];
  $('badge-no').textContent = oc[1] || '';

  scrub.max = D.frames.length - 1;
  scrub.value = 0;
  $('t-start').textContent = shortTs(D.frames[0].ts);
  $('t-end').textContent = shortTs(D.frames[D.frames.length-1].ts);

  buildSpeeds();
  idx = 0;
  render();
}

function buildSpeeds() {
  const row = $('speed-row'); row.innerHTML = '';
  SPEEDS.forEach(s => {
    const b = document.createElement('button');
    b.className = 'sp-btn' + (s === speed ? ' active' : '');
    b.textContent = s + 'x';
    b.onclick = () => {
      speed = s;
      row.querySelectorAll('.sp-btn').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      if (playing) { stop(); play(); }
    };
    row.appendChild(b);
  });
}

$('btn-play').onclick = toggle;
$('btn-prev').onclick = () => { stop(); go(idx-1); };
$('btn-next').onclick = () => { stop(); go(idx+1); };
$('btn-start').onclick = () => { stop(); go(0); };
$('btn-end').onclick = () => { stop(); go(D.frames.length-1); };
scrub.addEventListener('input', () => { stop(); go(+scrub.value); });

document.addEventListener('keydown', e => {
  if (!D) return;
  if (e.code === 'Space') { e.preventDefault(); toggle(); }
  if (e.code === 'ArrowLeft') { stop(); go(idx-1); }
  if (e.code === 'ArrowRight') { stop(); go(idx+1); }
  if (e.code === 'Home') { stop(); go(0); }
  if (e.code === 'End') { stop(); go(D.frames.length-1); }
});

function toggle() { playing ? stop() : play(); }
function play() {
  if (idx >= D.frames.length-1) idx = 0;
  playing = true;
  $('btn-play').innerHTML = '&#x23F8;';
  tick();
}
function stop() {
  playing = false;
  $('btn-play').innerHTML = '&#x25B6;';
  if (timer) { clearTimeout(timer); timer = null; }
}
function tick() {
  if (!playing) return;
  go(idx+1);
  if (idx >= D.frames.length-1) { stop(); return; }
  timer = setTimeout(tick, (interval * 1000) / speed);
}
function go(i) {
  if (!D) return;
  idx = Math.max(0, Math.min(i, D.frames.length-1));
  scrub.value = idx;
  render();
}

function render() {
  const f = D.frames[idx];
  const oc = (D.meta||{}).outcomes || ['Yes','No'];

  const yp = f.best_bid_p, np = f.best_bid_p != null ? +(1-f.best_bid_p).toFixed(2) : null;
  $('badge-yes').textContent = oc[0] + ' ' + (yp != null ? c(yp) : '--');
  $('badge-no').textContent = (oc[1]||'No') + ' ' + (np != null ? c(np) : '--');

  const mid = (f.best_bid_p != null && f.best_ask_p != null) ? (f.best_bid_p+f.best_ask_p)/2 : f.best_bid_p;
  $('mid-last').textContent = mid != null ? c(mid) : '--';
  $('mid-spread').textContent = f.spread != null ? c(f.spread) : '--';

  $('info-vol').textContent = f.volume != null ? comma(f.volume) : '0';
  $('info-trades').textContent = f.trades || 0;
  $('info-ts').textContent = shortTs(f.ts);
  $('frame-info').textContent = (idx+1) + '/' + D.frames.length;

  const asks = (f.asks||[]).slice().sort((a,b) => b.price - a.price);
  const bids = (f.bids||[]).slice().sort((a,b) => b.price - a.price);
  const maxSz = Math.max(...asks.map(a=>a.size||0), ...bids.map(b=>b.size||0), 1);

  buildRows($('asks'), asks, 'ask', maxSz);
  buildRows($('bids'), bids, 'bid', maxSz);

  const dr = $('depth-row');
  dr.innerHTML = '';
  [[1,'1c'],[5,'5c'],[10,'10c'],[15,'15c']].forEach(([_,k]) => {
    const bv = f['depth_bid_'+k], av = f['depth_ask_'+k];
    if (bv != null || av != null) {
      const el = document.createElement('span');
      el.className = 'depth-item';
      el.innerHTML = '\u00B1' + k + ': <span>' + comma(bv) + '</span> / <span>' + comma(av) + '</span>';
      dr.appendChild(el);
    }
  });
}

function buildRows(cont, levels, side, maxSz) {
  cont.innerHTML = '';
  const cls = side === 'ask' ? 'ask-row' : 'bid-row';
  const badgeCls = side === 'ask' ? 'ask-badge' : 'bid-badge';
  const badgeText = side === 'ask' ? 'Asks' : 'Bids';

  // Cumulative totals: asks accumulate from lowest price up, bids from highest down
  let cum = 0;
  const ordered = side === 'ask' ? [...levels].reverse() : levels;
  const cums = [];
  for (const l of ordered) { cum += (l.size||0) * (l.price||0); cums.push(cum); }
  if (side === 'ask') cums.reverse();

  // Badge position: asks -> last row (lowest price, nearest to mid), bids -> first row (highest price)
  const badgeIdx = side === 'ask' ? levels.length - 1 : 0;

  levels.forEach((l, i) => {
    const pct = maxSz > 0 ? ((l.size||0) / maxSz * 100) : 0;
    const row = document.createElement('div');
    row.className = 'ob-row ' + cls;

    const labelHtml = i === badgeIdx
      ? '<span class="side-badge ' + badgeCls + '">' + badgeText + '</span>'
      : '<span></span>';

    row.innerHTML =
      '<div class="bar" style="width:' + pct + '%"></div>' +
      labelHtml +
      '<span class="col-price">' + c(l.price) + '</span>' +
      '<span class="col-size">' + comma(l.size) + '</span>' +
      '<span class="col-total">$' + comma(cums[i]) + '</span>';
    cont.appendChild(row);
  });
}

function c(v) { return Math.round(v*100) + '\u00A2'; }
function comma(v) {
  if (v == null) return '--';
  return v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function shortTs(t) { return t ? t.replace(/^\d{4}-\d{2}-\d{2}\s*/,'').replace('Z','') : '--'; }
</script>
</body>
</html>
